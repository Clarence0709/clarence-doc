# Java总结-消息队列
## 一、消息队列的使用场景
以下介绍消息队列在实际应用常用的使用场景。异步处理、应用解耦、流量削锋、日志处理和消息通讯五个个场景：
【1】异步处理： 场景说明：用户注册后，需要发注册邮件和注册短信。

![img.png](../assets/interview/mq_1.png)

**引入消息队列后架构如下**：

用户的响应时间=注册信息写入数据库的时间，例如50毫秒。 发注册邮箱、发注册短信写入消息队列 后，直接返回客户端，因写入消息队列的速度很快，基本可以忽略，因此用户的响应时间可能是50毫秒。

按照传统的做法：

①、串行方式，将注册信息写入数据库成功后，发注册邮件，再发送注册短信，以上三个成功后，返回客户端。可能需要150毫秒，这样使用消息队列提高了3倍。

②、并行方式，将注册信息写入数据库成功后，发送注册邮件，同时发送注册短信。也可能需要100毫秒，这样使用消息队列提高了2倍。

【2】应用解耦：

场景说明：用户下单后，订单系统需要通知库存系统。如下图：

todo put image...

【3】流量削锋：

场景说明：秒杀或团抢活动中使用广泛。秒杀活动，一般会因为流量过大，导致流量暴增，应用挂掉。一般需要在应用前端加入消息队列。

todo put image...

【4】日志处理：

指将消息队列用在日志处理中，比如 Kafka 的应用，解决大量日志传输的问题。

todo put image...

【5】消息通信：

消息队列一般都内置了高效的通信机制，因此也可以用纯消息通信。比如实现点对点消息队列，或者聊天室。

todo put image...


## 二、消息队列的工作流程

![img.png](../assets/interview/mq_flow.png)

【1】发送端 MQ-Product （消息生产者）将消息发送给 MQ-server；


【2】MQ-server 将消息落地，持久化到数据库等；


【3】MQ-server 回 ACK 给 MQ-Producer；


【4】MQ-server 将消息发送给消息接收端 MQ-Consumer （消息消费者）；


【5】MQ-Consumer 消费接收到消息后发送 ACK 给 MQ-server；


【6】MQ-server 将落地消息删除；

## 三、MQ如何保证消息不丢失？

1、生产者消息发送回调处理：

即为异步发送，处理callback的重试机制；

2、消息刷盘完后，响应producer：

3、消息消费完成后，响应消息服务器：

总结：但是针对于不紧要的数据，提高系统速度，可以接受消息丢失问题

## 四、Mq消息的幂等性（重复消费）如何保证？

开篇：所有Mq产品都没有主动提供消费者重复消费的问题，最好的方式是自己做一个全局的唯一标识

1、全局唯一标识ID：

2、使用去重存储（如 Redis、数据库） 保存已经处理的消息标识符

3、其他方案：todo

## 五、Mq如何保证消息顺序消费？

todo

## 六、MQ如何保证消息的高效读写

## 七、MQ如何保证分布式事务的最终一致性

## 八、如何设计一个MQ？


## 九、RocketMQ常见面试题：


以下内容待实践后调整：

> 参考资料：[RocketMQ常见面试题](https://blog.csdn.net/ctwctw/article/details/107463884)

## 十、Kafka常见面试题：

以下内容待实践后调整：

> 参考资料：[Kafka常见面试题](https://javabetter.cn/interview/kafka-40.html)